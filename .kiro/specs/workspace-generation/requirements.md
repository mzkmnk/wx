# 要件ドキュメント

## はじめに

ワークスペース生成機能は、wx CLI ツールのコアロジックを提供します。この機能により、登録済みの bare リポジトリから Git worktree を作成し、それらを含む VSCode/Kiro の workspace ファイル（.code-workspace）を自動生成します。これにより、複数リポジトリの異なるブランチで並列開発を行う際の手作業を大幅に削減します。

## 用語集

- **wx**: Git worktree と VSCode workspace を管理する CLI ツール
- **ワークスペース生成システム**: worktree 作成と workspace ファイル生成を管理するサブシステム
- **worktree**: Git の worktree 機能で作成された作業ディレクトリ。元リポジトリとは別の場所でブランチを checkout できる
- **workspace ファイル**: VSCode/Kiro の `.code-workspace` ファイル。複数フォルダを 1 つのウィンドウで開ける
- **作業ディレクトリ**: `wx` コマンドを実行するディレクトリ。ここに worktree と workspace が生成される
- **登録リポジトリ**: `wx register` で登録された Git リポジトリ。`~/.wx/config.json` に保存されている
- **bare リポジトリ**: 作業ディレクトリを持たない Git リポジトリで、worktree の親として機能する
- **ブランチ**: Git のブランチ。worktree 作成時に指定する

## 要件

### 要件 1

**ユーザーストーリー:** 開発者として、登録済みリポジトリから worktree を作成したい。そうすることで、特定のブランチで作業を開始できるようにするため。

#### 受け入れ基準

1. WHEN ユーザーがリポジトリ名とブランチ名を指定して worktree 作成を要求する THEN ワークスペース生成システムは作業ディレクトリ内に `<リポジトリ名>/` ディレクトリとして worktree を作成しなければならない
2. WHEN worktree を作成する THEN ワークスペース生成システムは登録済み bare リポジトリ（~/.wx/<name>.git）を親として使用しなければならない
3. WHEN 指定されたブランチがリモートに存在する THEN ワークスペース生成システムはそのブランチを checkout した worktree を作成しなければならない
4. WHEN 指定されたブランチがリモートに存在しない THEN ワークスペース生成システムは新しいブランチを作成して worktree を作成しなければならない
5. WHEN 同じ場所に既に worktree が存在する THEN ワークスペース生成システムはエラーを返し、既存の worktree を上書きしてはならない

### 要件 2

**ユーザーストーリー:** 開発者として、複数の worktree を含む workspace ファイルを生成したい。そうすることで、VSCode/Kiro で複数リポジトリを一度に開けるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが workspace 生成を要求する THEN ワークスペース生成システムは作業ディレクトリに `.code-workspace` ファイルを作成しなければならない
2. WHEN workspace ファイルを生成する THEN ワークスペース生成システムは指定されたすべての worktree フォルダを `folders` 配列に含めなければならない
3. WHEN workspace 名が指定される THEN ワークスペース生成システムは `<workspace名>.code-workspace` というファイル名を使用しなければならない
4. WHEN workspace 名が指定されない THEN ワークスペース生成システムは作業ディレクトリ名を workspace 名として使用しなければならない
5. WHEN 同じ名前の workspace ファイルが既に存在する THEN ワークスペース生成システムはエラーを返し、既存のファイルを上書きしてはならない

### 要件 3

**ユーザーストーリー:** 開発者として、登録済みリポジトリの利用可能なブランチ一覧を取得したい。そうすることで、worktree を作成するブランチを選択できるようにするため。

#### 受け入れ基準

1. WHEN ユーザーがリポジトリのブランチ一覧を要求する THEN ワークスペース生成システムは bare リポジトリからすべてのリモートブランチを取得しなければならない
2. WHEN ブランチ一覧を取得する前 THEN ワークスペース生成システムは bare リポジトリを fetch して最新の状態に更新しなければならない
3. WHEN ブランチ一覧を返す THEN ワークスペース生成システムはデフォルトブランチ（main または master）を先頭に配置しなければならない
4. WHEN bare リポジトリが存在しない THEN ワークスペース生成システムはリポジトリが登録されていないことを示すエラーを返さなければならない

### 要件 4

**ユーザーストーリー:** 開発者として、作業ディレクトリの worktree と workspace を削除したい。そうすることで、不要になった作業環境をクリーンアップできるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが `wx clean <workspace名>` を実行する THEN ワークスペース生成システムは指定された workspace に関連する worktree と workspace ファイルを削除しなければならない
2. WHEN ユーザーが `wx clean --all` を実行する THEN ワークスペース生成システムは作業ディレクトリ内のすべての wx 管理 worktree と workspace ファイルを削除しなければならない
3. WHEN ユーザーが引数なしで `wx clean` を実行する THEN ワークスペース生成システムは使用方法を表示し、削除を実行してはならない
4. WHEN worktree を削除する THEN ワークスペース生成システムは Git の worktree prune を実行して親リポジトリの参照を更新しなければならない
5. WHEN worktree 削除が完了する THEN ワークスペース生成システムは対応する `.code-workspace` ファイルを削除しなければならない
6. WHEN 作業ディレクトリに wx 管理外のファイルが存在する THEN ワークスペース生成システムはそれらのファイルを削除してはならない
7. WHEN 削除対象の worktree が存在しない THEN ワークスペース生成システムは警告メッセージを表示し、処理を継続しなければならない

### 要件 5

**ユーザーストーリー:** 開発者として、workspace ファイルが正しい JSON 形式で生成されてほしい。そうすることで、VSCode/Kiro が問題なく読み込めるようにするため。

#### 受け入れ基準

1. WHEN workspace ファイルを生成する THEN ワークスペース生成システムは有効な JSON 形式で出力しなければならない
2. WHEN workspace ファイルを生成する THEN ワークスペース生成システムは `folders` 配列に各 worktree への相対パスを含めなければならない
3. WHEN workspace ファイルを生成する THEN ワークスペース生成システムは空の `settings` オブジェクトを含めなければならない
4. WHEN workspace ファイルを読み込む THEN ワークスペース生成システムは JSON 構造を検証しなければならない

### 要件 6

**ユーザーストーリー:** 開発者として、ワークスペース生成システムがエラーを適切に処理してほしい。そうすることで、何が問題で、どのように修正すればよいかを理解できるようにするため。

#### 受け入れ基準

1. WHEN 指定されたリポジトリが登録されていない THEN ワークスペース生成システムはリポジトリが見つからないことを示すエラーメッセージを表示しなければならない
2. WHEN Git worktree 操作が失敗する THEN ワークスペース生成システムは失敗した操作と Git エラー出力を含むエラーメッセージを表示しなければならない
3. WHEN ファイルシステム操作が失敗する THEN ワークスペース生成システムは失敗した操作と根本的なエラーを含むエラーメッセージを表示しなければならない
4. WHEN ディスクスペース不足が worktree 作成を妨げる THEN ワークスペース生成システムはディスクスペースの問題を示すエラーメッセージを表示しなければならない
5. WHEN 部分的に worktree が作成された状態でエラーが発生する THEN ワークスペース生成システムは作成済みの worktree をロールバックしなければならない
