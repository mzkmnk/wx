# 要件ドキュメント

## はじめに

リポジトリ登録機能は、wx CLI ツールが Git リポジトリを管理するための基盤機能を提供します。この機能により、ユーザーは Git リポジトリを bare クローンとして一元管理された場所(~/.wx/)に登録し、登録済みリポジトリの一覧表示、不要になったリポジトリの登録解除が可能になります。これは他のすべての wx 機能の前提条件であり、登録されたリポジトリが worktree を作成するためのソースとして機能します。

## 用語集

- **wx**: Git worktree と VSCode workspace を管理する CLI ツール
- **リポジトリ登録システム**: 登録された Git リポジトリのライフサイクルを管理するサブシステム
- **Bare リポジトリ**: 作業ディレクトリを持たない Git リポジトリで、複数の worktree の親として機能するために最適化されている
- **設定ファイル**: 登録されたリポジトリのメタデータを保存する~/.wx/config.json の JSON ファイル
- **リポジトリ名**: リポジトリ URL から派生した一意の識別子（例: "git@github.com:org/frontend.git"から"frontend"）
- **リモート URL**: リポジトリをクローンするために使用される Git URL（HTTPS および SSH プロトコルをサポート）
- **ローカルパス**: bare リポジトリが保存される絶対パス（例: ~/.wx/frontend.git）

## 要件

### 要件 1

**ユーザーストーリー:** 開発者として、wx に Git リポジトリを登録したい。そうすることで、プロジェクトで worktree を作成するためのソースとして使用できるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが有効な Git URL で`wx register <url>`を実行する THEN リポジトリ登録システムは~/.wx/<name>.git にリポジトリの bare クローンを作成しなければならない
2. WHEN bare クローンが正常に完了する THEN リポジトリ登録システムはリポジトリ名、リモート URL、ローカルパスを含むエントリを~/.wx/config.json に追加しなければならない
3. WHEN ユーザーが既に登録されている URL でリポジトリを登録しようとする THEN リポジトリ登録システムは操作を拒否し、リポジトリが既に登録されていることを示すエラーメッセージを表示しなければならない
4. WHEN ~/.wx ディレクトリが存在しない THEN リポジトリ登録システムは bare クローンを実行する前にそれを作成しなければならない
5. WHEN config.json ファイルが存在しない THEN リポジトリ登録システムは新しいエントリを追加する前に空の repositories アレイでそれを作成しなければならない

### 要件 2

**ユーザーストーリー:** 開発者として、登録済みのすべてのリポジトリを表示したい。そうすることで、worktree を作成するために利用可能なリポジトリを確認できるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが`wx list`を実行する THEN リポジトリ登録システムは~/.wx/config.json を読み込み、すべての登録済みリポジトリを表示しなければならない
2. WHEN リポジトリ情報を表示する THEN リポジトリ登録システムは各エントリのリポジトリ名、リモート URL、ローカルパスを表示しなければならない
3. WHEN リポジトリが登録されていない THEN リポジトリ登録システムは利用可能なリポジトリがないことを示すメッセージを表示しなければならない
4. WHEN config.json ファイルが存在しない THEN リポジトリ登録システムは利用可能なリポジトリがないことを示すメッセージを表示しなければならない
5. WHEN config.json ファイルが不正な形式である THEN リポジトリ登録システムはパース失敗の詳細を含むエラーメッセージを表示しなければならない

### 要件 3

**ユーザーストーリー:** 開発者として、wx からリポジトリの登録を解除したい。そうすることで、不要になったリポジトリを削除し、ディスクスペースを解放できるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが有効なリポジトリ名で`wx unregister <name>`を実行する THEN リポジトリ登録システムはローカルパスの bare リポジトリディレクトリを削除しなければならない
2. WHEN bare リポジトリディレクトリの削除が成功する THEN リポジトリ登録システムは~/.wx/config.json からエントリを削除しなければならない
3. WHEN ユーザーが存在しないリポジトリの登録を解除しようとする THEN リポジトリ登録システムはリポジトリが見つからなかったことを示すエラーメッセージを表示しなければならない
4. WHEN bare リポジトリディレクトリを削除できない THEN リポジトリ登録システムはエラーメッセージを表示し、config.json からエントリを削除してはならない
5. WHEN 登録解除操作が正常に完了する THEN リポジトリ登録システムは確認メッセージを表示しなければならない

### 要件 4

**ユーザーストーリー:** 開発者として、登録システムが Git URL を検証してほしい。そうすることで、無効な URL を提供した場合に即座にフィードバックを受け取れるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが Git URL を提供する THEN リポジトリ登録システムは URL が SSH または HTTPS 形式のいずれかに一致することを検証しなければならない
2. WHEN Git URL が無効である THEN リポジトリ登録システムは操作を拒否し、期待される形式を説明するエラーメッセージを表示しなければならない
3. WHEN Git URL が有効だがリポジトリにアクセスできない THEN リポジトリ登録システムはクローン操作が失敗したことを示すエラーメッセージを表示しなければならない
4. WHEN URL からリポジトリ名を抽出する THEN リポジトリ登録システムは.git 拡張子を除いた最後のパスコンポーネントを使用しなければならない
5. WHEN 抽出されたリポジトリ名が既存の登録済みリポジトリと競合する THEN リポジトリ登録システムは操作を拒否しなければならない

### 要件 5

**ユーザーストーリー:** 開発者として、登録システムがエラーを適切に処理してほしい。そうすることで、何が問題で、どのように修正すればよいかを理解できるようにするため。

#### 受け入れ基準

1. WHEN ファイルシステム操作が失敗する THEN リポジトリ登録システムは失敗した特定の操作と根本的なエラーを含むエラーメッセージを表示しなければならない
2. WHEN Git 操作が失敗する THEN リポジトリ登録システムは失敗した Git コマンドとエラー出力を含むエラーメッセージを表示しなければならない
3. WHEN config.json ファイルが破損する THEN リポジトリ登録システムはエラーメッセージを表示し、手動復旧手順を提案しなければならない
4. WHEN ディスクスペース不足がクローンを妨げる THEN リポジトリ登録システムはディスクスペースの問題を示すエラーメッセージを表示しなければならない
5. WHEN ネットワーク接続の問題がクローンを妨げる THEN リポジトリ登録システムはネットワークの問題を示すエラーメッセージを表示しなければならない

### 要件 6

**ユーザーストーリー:** 開発者として、登録システムが設定を安全に永続化してほしい。そうすることで、bare クローン中に問題が発生しても config.json ファイルが破損した状態のまま残されることがないようにするため。

#### 受け入れ基準

1. WHEN bare クローンを開始する前 THEN リポジトリ登録システムは現在の config.json を config.backup.json にコピーしなければならない
2. WHEN bare クローンが正常に完了する THEN リポジトリ登録システムは config.json を更新し、config.backup.json を削除しなければならない
3. WHEN bare クローンが失敗する THEN リポジトリ登録システムは config.backup.json から元の config.json を復元し、エラーメッセージを表示しなければならない
4. WHEN config.json を読み込む THEN リポジトリ登録システムはデータを使用する前に JSON 構造を検証しなければならない
5. WHEN JSON 構造が無効である THEN リポジトリ登録システムはファイルを変更せずにエラーメッセージを表示しなければならない
