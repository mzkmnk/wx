# 実装計画

- [x] 1. ratatui プロジェクトの初期セットアップ

  - `cargo generate ratatui/templates simple`を実行してプロジェクト構造を生成
  - 生成されたテンプレートを確認（UI の実装は行わない）
  - _要件: なし（将来の interactive-ui spec のための準備）_

- [x] 2. プロジェクト構造とコア型の設定

  - Cargo.toml に追加の依存関係を追加（clap, git2, serde, serde_json, anyhow, thiserror, proptest, dirs）
  - src/ディレクトリ構造を作成（cli, commands, service, config, git, models, utils）
  - エラー型（RegistrationError）を定義
  - データモデル（Config, Repository）を定義
  - _要件: 1.1, 1.2, 2.1, 3.1, 4.1, 6.1_

- [ ] 3. 設定管理機能の実装（TDD）
- [x] 3.1 ConfigManager のテストを作成

  - load()メソッドのテスト（JSON 読み込みと検証）
  - save()メソッドのテスト（JSON 書き込み）
  - create_backup()、restore_backup()、delete_backup()メソッドのテスト
  - テストが失敗することを確認（Red）
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 3.2 ConfigManager の実装

  - ConfigManager 構造体と new()メソッドを実装
  - load()メソッドを実装（JSON 読み込みと検証）
  - save()メソッドを実装（JSON 書き込み）
  - create_backup()、restore_backup()、delete_backup()メソッドを実装
  - テストが通ることを確認（Green）
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ]\* 3.3 ConfigManager のプロパティテストを作成

  - **プロパティ 14: JSON 構造検証**
  - **検証: 要件 6.4**

- [ ]\* 3.4 ConfigManager のプロパティテストを作成

  - **プロパティ 15: 無効な JSON 拒否**
  - **検証: 要件 6.5**

- [ ] 4. Git 操作機能の実装（TDD）
- [x] 4.1 GitOperations のテストを作成

  - validate_url()メソッドのテスト（SSH/HTTPS 形式の検証）
  - extract_repo_name()メソッドのテスト（URL からリポジトリ名を抽出）
  - bare_clone()メソッドのテスト（git2 を使用した bare クローン）
  - テストが失敗することを確認（Red）
  - _要件: 1.1, 4.1, 4.2, 4.3, 4.4_

- [x] 4.2 GitOperations 構造体の実装

  - GitOperations 構造体と new()メソッドを実装
  - validate_url()メソッドを実装（SSH/HTTPS 形式の検証）
  - extract_repo_name()メソッドを実装（URL からリポジトリ名を抽出）
  - bare_clone()メソッドを実装（git2 を使用した bare クローン）
  - テストが通ることを確認（Green）
  - _要件: 1.1, 4.1, 4.2, 4.3, 4.4_

- [ ]\* 4.3 GitOperations のプロパティテストを作成

  - **プロパティ 9: URL 検証の正確性**
  - **検証: 要件 4.1**

- [ ]\* 4.4 GitOperations のプロパティテストを作成

  - **プロパティ 10: 無効な URL 拒否**
  - **検証: 要件 4.2**

- [ ]\* 4.5 GitOperations のプロパティテストを作成

  - **プロパティ 11: リポジトリ名抽出の正確性**
  - **検証: 要件 4.4**

- [ ] 5. リポジトリサービスの実装（TDD）
- [x] 5.1 RepositoryService のテストを作成

  - register()メソッドのテスト（バックアップ作成、bare クローン、config 更新）
  - list()メソッドのテスト（登録済みリポジトリの一覧取得）
  - unregister()メソッドのテスト（config 更新、ディレクトリ削除）
  - テストが失敗することを確認（Red）
  - _要件: 1.1, 1.2, 1.3, 2.1, 2.2, 3.1, 3.2, 3.3_

- [x] 5.2 RepositoryService の実装

  - RepositoryService 構造体と new()メソッドを実装
  - register()メソッドを実装（バックアップ作成、bare クローン、config 更新）
  - list()メソッドを実装（登録済みリポジトリの一覧取得）
  - unregister()メソッドを実装（config 更新、ディレクトリ削除）
  - テストが通ることを確認（Green）
  - _要件: 1.1, 1.2, 1.3, 2.1, 2.2, 3.1, 3.2, 3.3_

- [ ]\* 5.3 register 操作のプロパティテストを作成

  - **プロパティ 1: 登録後の bare リポジトリ存在**
  - **検証: 要件 1.1**

- [ ]\* 5.4 register 操作のプロパティテストを作成

  - **プロパティ 2: 登録後の config.json エントリ追加**
  - **検証: 要件 1.2**

- [ ]\* 5.5 register 操作のプロパティテストを作成

  - **プロパティ 3: 重複登録の拒否**
  - **検証: 要件 1.3, 4.5**

- [ ]\* 5.6 register 操作のプロパティテストを作成

  - **プロパティ 12: バックアップ作成**
  - **検証: 要件 6.1**

- [ ]\* 5.7 register 操作のプロパティテストを作成

  - **プロパティ 13: 成功時のバックアップ削除**
  - **検証: 要件 6.2**

- [ ]\* 5.8 list 操作のプロパティテストを作成

  - **プロパティ 4: list 操作の完全性**
  - **検証: 要件 2.1**

- [ ]\* 5.9 list 操作のプロパティテストを作成

  - **プロパティ 5: リポジトリ情報の完全性**
  - **検証: 要件 2.2**

- [ ]\* 5.10 unregister 操作のプロパティテストを作成

  - **プロパティ 6: unregister 後のディレクトリ削除**
  - **検証: 要件 3.1**

- [ ]\* 5.11 unregister 操作のプロパティテストを作成

  - **プロパティ 7: unregister 後の config.json エントリ削除**
  - **検証: 要件 3.2**

- [ ]\* 5.12 unregister 操作のプロパティテストを作成

  - **プロパティ 8: 未登録リポジトリの unregister 拒否**
  - **検証: 要件 3.3**

- [ ] 6. チェックポイント - すべてのテストが合格することを確認

  - すべてのテストが合格することを確認し、問題があればユーザーに質問する

- [ ] 7. CLI コマンドハンドラーの実装（TDD）
- [ ] 7.1 CLI パーサーのテストを作成

  - clap 構造体（Cli, Commands）のパーステスト
  - テストが失敗することを確認（Red）
  - _要件: 1.1, 2.1, 3.1_

- [ ] 7.2 CLI パーサーの実装

  - clap 構造体（Cli, Commands）を定義
  - main.rs で CLI パーサーを統合
  - テストが通ることを確認（Green）
  - _要件: 1.1, 2.1, 3.1_

- [ ] 7.3 register コマンドハンドラーのテストを作成

  - commands/register.rs のテスト
  - エラーハンドリングとユーザーフィードバックのテスト
  - テストが失敗することを確認（Red）
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 7.4 register コマンドハンドラーの実装

  - commands/register.rs を実装
  - RepositoryService の register()を呼び出し
  - エラーハンドリングとユーザーフィードバックを実装
  - テストが通ることを確認（Green）
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [ ] 7.5 list コマンドハンドラーのテストを作成

  - commands/list.rs のテスト
  - フォーマットされた出力のテスト
  - テストが失敗することを確認（Red）
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 7.6 list コマンドハンドラーの実装

  - commands/list.rs を実装
  - RepositoryService の list()を呼び出し
  - フォーマットされた出力を実装
  - テストが通ることを確認（Green）
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ] 7.7 unregister コマンドハンドラーのテストを作成

  - commands/unregister.rs のテスト
  - 確認メッセージのテスト
  - ディレクトリ削除失敗時に config.json が変更されないことのテスト
  - テストが失敗することを確認（Red）
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 7.8 unregister コマンドハンドラーの実装

  - commands/unregister.rs を実装
  - RepositoryService の unregister()を呼び出し
  - ディレクトリ削除成功後にのみ config.json を更新
  - 確認メッセージを実装
  - テストが通ることを確認（Green）
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 7.9 CLI コマンドの統合テストを作成

  - register → list → unregister の完全なフローをテスト
  - エラーシナリオをテスト
  - _要件: 1.1, 1.2, 1.3, 2.1, 2.2, 3.1, 3.2, 3.3_

- [ ] 8. エッジケースとエラーハンドリングの実装（TDD）
- [ ] 8.1 初期化処理のテストを作成

  - ~/.wtx ディレクトリが存在しない場合のテスト
  - config.json が存在しない場合のテスト
  - テストが失敗することを確認（Red）
  - _要件: 1.4, 1.5_

- [ ] 8.2 初期化処理の実装

  - ~/.wtx ディレクトリが存在しない場合の作成処理
  - config.json が存在しない場合の初期化処理
  - テストが通ることを確認（Green）
  - _要件: 1.4, 1.5_

- [ ] 8.3 エラーメッセージのテストを作成

  - 各エラーケースに対する詳細なメッセージのテスト
  - ユーザーフレンドリーなエラー表示のテスト
  - テストが失敗することを確認（Red）
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 8.4 エラーメッセージの実装

  - 各エラーケースに対する詳細なメッセージを実装
  - ユーザーフレンドリーなエラー表示を実装
  - テストが通ることを確認（Green）
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ] 8.5 エッジケースのユニットテストを作成

  - 空のリポジトリリストでの list 操作
  - 存在しない config.json での list 操作
  - 不正な JSON での load 操作
  - ディレクトリ削除失敗時の unregister 操作（config.json が変更されないことを確認）
  - _要件: 2.3, 2.4, 2.5, 3.4_

- [ ] 9. 最終チェックポイント - すべてのテストが合格することを確認
  - すべてのテストが合格することを確認し、問題があればユーザーに質問する
