# 要件ドキュメント

## はじめに

Clone ベースワークスペース機能は、wx CLI ツールの Git リポジトリ管理とワークスペース生成を提供します。従来の bare リポジトリ + worktree 方式から、シンプルな逐次 clone 方式に変更することで、状態管理を簡素化し、VSCode/Kiro と同等の Git 操作を実現します。

## 用語集

- **wx**: Git clone と VSCode workspace を管理する CLI ツール
- **リポジトリ登録システム**: 登録された Git リポジトリ URL を管理するサブシステム
- **ワークスペース生成システム**: git clone と workspace ファイル生成を管理するサブシステム
- **設定ファイル**: 登録されたリポジトリの URL と作成済み workspace を保存する ~/.wx/config.json の JSON ファイル
- **リポジトリ名**: リポジトリ URL から派生した一意の識別子（例: "git@github.com:org/frontend.git" から "frontend"）
- **リモート URL**: リポジトリをクローンするために使用される Git URL（HTTPS および SSH プロトコルをサポート）
- **workspace ファイル**: VSCode/Kiro の `.code-workspace` ファイル。複数フォルダを 1 つのウィンドウで開ける
- **作業ディレクトリ**: `wx` コマンドを実行するディレクトリ。ここに clone と workspace が生成される
- **管理対象 workspace**: wx で作成され、config.json に記録された workspace。UUID で一意に識別される

## 要件

### 要件 1

**ユーザーストーリー:** 開発者として、wx に Git リポジトリを登録したい。そうすることで、プロジェクトで clone を作成するためのソースとして使用できるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが有効な Git URL で `wx register <url>` を実行する THEN リポジトリ登録システムはリポジトリ名とリモート URL を ~/.wx/config.json に追加しなければならない
2. WHEN ユーザーが既に登録されている URL でリポジトリを登録しようとする THEN リポジトリ登録システムは操作を拒否し、リポジトリが既に登録されていることを示すエラーメッセージを表示しなければならない
3. WHEN ~/.wx ディレクトリが存在しない THEN リポジトリ登録システムは config.json を作成する前にそれを作成しなければならない
4. WHEN config.json ファイルが存在しない THEN リポジトリ登録システムは新しいエントリを追加する前に空の repositories 配列でそれを作成しなければならない
5. WHEN 登録が成功する THEN リポジトリ登録システムは確認メッセージを表示しなければならない

### 要件 2

**ユーザーストーリー:** 開発者として、登録済みのすべてのリポジトリを表示したい。そうすることで、clone を作成するために利用可能なリポジトリを確認できるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが `wx list` を実行する THEN リポジトリ登録システムは ~/.wx/config.json を読み込み、すべての登録済みリポジトリを表示しなければならない
2. WHEN リポジトリ情報を表示する THEN リポジトリ登録システムは各エントリのリポジトリ名とリモート URL を表示しなければならない
3. WHEN リポジトリが登録されていない THEN リポジトリ登録システムは利用可能なリポジトリがないことを示すメッセージを表示しなければならない
4. WHEN config.json ファイルが存在しない THEN リポジトリ登録システムは利用可能なリポジトリがないことを示すメッセージを表示しなければならない

### 要件 3

**ユーザーストーリー:** 開発者として、wx からリポジトリの登録を解除したい。そうすることで、不要になったリポジトリを管理対象から外せるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが有効なリポジトリ名で `wx unregister <name>` を実行する THEN リポジトリ登録システムは ~/.wx/config.json からエントリを削除しなければならない
2. WHEN ユーザーが存在しないリポジトリの登録を解除しようとする THEN リポジトリ登録システムはリポジトリが見つからなかったことを示すエラーメッセージを表示しなければならない
3. WHEN 登録解除操作が正常に完了する THEN リポジトリ登録システムは確認メッセージを表示しなければならない

### 要件 4

**ユーザーストーリー:** 開発者として、登録システムが Git URL を検証してほしい。そうすることで、無効な URL を提供した場合に即座にフィードバックを受け取れるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが Git URL を提供する THEN リポジトリ登録システムは URL が SSH または HTTPS 形式のいずれかに一致することを検証しなければならない
2. WHEN Git URL が無効である THEN リポジトリ登録システムは操作を拒否し、期待される形式を説明するエラーメッセージを表示しなければならない
3. WHEN URL からリポジトリ名を抽出する THEN リポジトリ登録システムは .git 拡張子を除いた最後のパスコンポーネントを使用しなければならない
4. WHEN 抽出されたリポジトリ名が既存の登録済みリポジトリと競合する THEN リポジトリ登録システムは操作を拒否しなければならない

### 要件 5

**ユーザーストーリー:** 開発者として、登録済みリポジトリを作業ディレクトリに clone したい。そうすることで、特定のブランチで作業を開始できるようにするため。

#### 受け入れ基準

1. WHEN ユーザーがリポジトリ名とブランチ名を指定して clone 作成を要求する THEN ワークスペース生成システムは作業ディレクトリ内に `<リポジトリ名>/` ディレクトリとして git clone を実行しなければならない
2. WHEN 指定されたブランチがリモートに存在する THEN ワークスペース生成システムはそのブランチを checkout し、upstream を設定しなければならない
3. WHEN 指定されたブランチがリモートに存在しない THEN ワークスペース生成システムはデフォルトブランチから新しいブランチを作成しなければならない
4. WHEN 同じ場所に既にディレクトリが存在する THEN ワークスペース生成システムはエラーを返し、既存のディレクトリを上書きしてはならない
5. WHEN clone が成功する THEN ワークスペース生成システムは clone されたリポジトリのパスとブランチ名を表示しなければならない

### 要件 6

**ユーザーストーリー:** 開発者として、複数の clone を含む workspace ファイルを生成したい。そうすることで、VSCode/Kiro で複数リポジトリを一度に開けるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが workspace 生成を要求する THEN ワークスペース生成システムは作業ディレクトリに `.code-workspace` ファイルを作成しなければならない
2. WHEN workspace ファイルを生成する THEN ワークスペース生成システムは指定されたすべての clone フォルダを `folders` 配列に含めなければならない
3. WHEN workspace 名が指定される THEN ワークスペース生成システムは `<workspace名>.code-workspace` というファイル名を使用しなければならない
4. WHEN workspace 名が指定されない THEN ワークスペース生成システムは作業ディレクトリ名を workspace 名として使用しなければならない
5. WHEN 同じ名前の workspace ファイルが既に存在する THEN ワークスペース生成システムはエラーを返し、既存のファイルを上書きしてはならない

### 要件 7

**ユーザーストーリー:** 開発者として、登録済みリポジトリの利用可能なブランチ一覧を取得したい。そうすることで、clone を作成するブランチを選択できるようにするため。

#### 受け入れ基準

1. WHEN ユーザーがリポジトリのブランチ一覧を要求する THEN ワークスペース生成システムは git ls-remote を使用してリモートブランチを取得しなければならない
2. WHEN ブランチ一覧を返す THEN ワークスペース生成システムはデフォルトブランチ（main または master）を先頭に配置しなければならない
3. WHEN リモートリポジトリにアクセスできない THEN ワークスペース生成システムはネットワークエラーを示すエラーメッセージを表示しなければならない

### 要件 8

**ユーザーストーリー:** 開発者として、作業ディレクトリの clone と workspace を削除したい。そうすることで、不要になった作業環境をクリーンアップできるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが `wx clean` を実行する THEN ワークスペース生成システムは作業ディレクトリ内の wx 管理 clone ディレクトリと workspace ファイルを削除しなければならない
2. WHEN 作業ディレクトリに wx 管理外のファイルが存在する THEN ワークスペース生成システムはそれらのファイルを削除してはならない
3. WHEN 削除対象のディレクトリが存在しない THEN ワークスペース生成システムは警告メッセージを表示し、処理を継続しなければならない
4. WHEN 削除が完了する THEN ワークスペース生成システムは削除されたディレクトリとファイルの一覧を表示しなければならない

### 要件 9

**ユーザーストーリー:** 開発者として、workspace ファイルが正しい JSON 形式で生成されてほしい。そうすることで、VSCode/Kiro が問題なく読み込めるようにするため。

#### 受け入れ基準

1. WHEN workspace ファイルを生成する THEN ワークスペース生成システムは有効な JSON 形式で出力しなければならない
2. WHEN workspace ファイルを生成する THEN ワークスペース生成システムは `folders` 配列に各 clone への相対パスを含めなければならない
3. WHEN workspace ファイルを生成する THEN ワークスペース生成システムは空の `settings` オブジェクトを含めなければならない

### 要件 10

**ユーザーストーリー:** 開発者として、作成済みの workspace 一覧を表示したい。そうすることで、どの workspace がどこに作成されているかを確認できるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが `wx list-workspaces` を実行する THEN ワークスペース生成システムは ~/.wx/config.json から作成済み workspace 一覧を表示しなければならない
2. WHEN workspace 情報を表示する THEN ワークスペース生成システムは各 workspace の名前、パス、含まれるリポジトリ、作成日時、更新日時を表示しなければならない
3. WHEN workspace が作成されていない THEN ワークスペース生成システムは作成済み workspace がないことを示すメッセージを表示しなければならない

### 要件 11

**ユーザーストーリー:** 開発者として、作成済みの workspace を削除したい。そうすることで、不要になった workspace とその clone を一括で削除できるようにするため。

#### 受け入れ基準

1. WHEN ユーザーが `wx rm-workspace` を実行する THEN ワークスペース生成システムは作成済み workspace の一覧を表示し、削除対象を選択させなければならない
2. WHEN ユーザーが workspace を選択する THEN ワークスペース生成システムは選択された workspace の .code-workspace ファイルと関連する clone ディレクトリを削除しなければならない
3. WHEN workspace を削除する THEN ワークスペース生成システムは ~/.wx/config.json から該当 workspace のエントリを削除しなければならない
4. WHEN 作成済み workspace が存在しない THEN ワークスペース生成システムは削除対象がないことを示すメッセージを表示しなければならない
5. WHEN 削除が完了する THEN ワークスペース生成システムは削除された workspace 名とファイル一覧を表示しなければならない

### 要件 12

**ユーザーストーリー:** 開発者として、workspace 作成時にメタデータが記録されてほしい。そうすることで、後から workspace の情報を確認できるようにするため。

#### 受け入れ基準

1. WHEN workspace を作成する THEN ワークスペース生成システムは UUID v4（ランダム生成）を生成して workspace の一意識別子として使用しなければならない
2. WHEN workspace を作成する THEN ワークスペース生成システムは作成日時（created_at）を記録しなければならない
3. WHEN workspace を作成する THEN ワークスペース生成システムは更新日時（updated_at）を作成日時と同じ値で記録しなければならない
4. WHEN workspace のメタデータを記録する THEN ワークスペース生成システムは workspace ファイルのパス、含まれるリポジトリ名、ブランチ名、clone パスを記録しなければならない

### 要件 13

**ユーザーストーリー:** 開発者として、システムがエラーを適切に処理してほしい。そうすることで、何が問題で、どのように修正すればよいかを理解できるようにするため。

#### 受け入れ基準

1. WHEN ファイルシステム操作が失敗する THEN システムは失敗した特定の操作と根本的なエラーを含むエラーメッセージを表示しなければならない
2. WHEN Git 操作が失敗する THEN システムは失敗した Git コマンドとエラー出力を含むエラーメッセージを表示しなければならない
3. WHEN config.json ファイルが破損する THEN システムはエラーメッセージを表示し、手動復旧手順を提案しなければならない
4. WHEN ネットワーク接続の問題が clone を妨げる THEN システムはネットワークの問題を示すエラーメッセージを表示しなければならない
